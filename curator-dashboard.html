<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Кабинет куратора</title>
  <link rel="stylesheet" href="univer-style.css" />
  <div id="accessDeniedMessage" style="display:none; padding: 10px; background: #ffcccc; color: #a00; font-weight: bold; text-align: center;">
    Доступ только для кураторов. Перенаправление на страницу входа...
  </div>
  
  <script>
    const role = localStorage.getItem('role');
    const id = localStorage.getItem('userId');
    const allowedRole = 'curator';
    const messageBlock = document.getElementById('accessDeniedMessage');
  
    if (!id || role !== allowedRole) {
      messageBlock.style.display = 'block';
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 3000);
    }
  </script>
  
</head>
<body>
  <div class="page-wrapper">
    <header class="header">
        <div class="header-top improved-header">
          <div class="header-brand">
            <img src="img/logo.png" alt="Logo" class="header-logo" />
            <div class="header-title">Students medical app</div>
          </div>
        </div>
        
        <!-- Навигационное меню -->
        <nav class="header-menu">
            <ul class="menu">
            <li><a href="home.html">Главное</a></li>
            <li><a href="https://www.kstu.kz/" target="_blank">Оф.сайт университета</a></li>
            <li><a href="https://egov.kz/cms/kk" target="_blank">egov</a></li>
            </ul>
            <ul class="menu exit">
            <li><a href="#" id="changePasswordBtn">Сменить пароль</a></li>
            <!-- КНОПКИ ДЛЯ ПЕРЕКЛЮЧЕНИЯ ВИДА -->
            <li><a href="#" id="showStudents">Студенты</a></li>
            <li><a href="#" id="showNotifications">Уведомления</a></li>
            <li><a href="login.html">Выход</a></li>
          </ul>          
        </nav>
        
    </header>
      

    <main class="main-content">
      <section class="center-content">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0;">Студенты вашей группы</h2>
            <span id="curatorGroupInfo" style="font-size: 1rem; color: #333;"></span>
          </div>  
          <section id="notifications" style="display:none; margin-bottom:1.5rem;">
          <h2>Уведомления</h2>
            <ul id="notificationList" class="notifications-list">
            <li>Загрузка...</li>
          </ul>
        </section>        
        <div id="studentList"></div>
        <div id="dynamicContent"></div>
      </section>
    </main>

    <footer class="footer">
      © 2025 Students medical app
    </footer>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Элементы для переключения вида
  const studentListEl   = document.getElementById('studentList');
  const notificationsEl = document.getElementById('notifications');
  const groupElement    = document.getElementById('curatorGroupInfo');

  // Загрузка и рендер уведомлений
  function loadNotifications() {
    const curatorId = localStorage.getItem('userId');
    fetch(`https://medapp-to7o.onrender.com/api/notifications/${curatorId}`)
      .then(res => res.json())
      .then(data => {
        const ul = document.getElementById('notificationList');
        ul.innerHTML = '';
        // бейдж с кол-вом непрочитанных
        const unread = data.filter(n => n.is_read === 0).length;
        notifCountEl.textContent = unread;
        if (!data.length) {
          ul.innerHTML = '<li>Нет новых уведомлений.</li>';
          return;
        }
        data.forEach(n => {
          const li = document.createElement('li');
          li.textContent = `${new Date(n.created_at).toLocaleString()}: ${n.message}`;
          if (n.is_read === 0) li.style.fontWeight = 'bold';
          // при клике помечаем как прочитанное
          li.addEventListener('click', () => {
            fetch(`https://medapp-to7o.onrender.com/api/notifications/${n.id}/read`, { method: 'POST' })
              .then(() => li.style.fontWeight = 'normal');
          });
          ul.appendChild(li);
        });
      })
      .catch(err => {
        console.error('Ошибка загрузки уведомлений:', err);
        document.getElementById('notificationList').innerHTML = '<li>Ошибка загрузки.</li>';
        notifCountEl.textContent = '0';
      });
  }

  // Переключение между списком студентов и уведомлениями
  function showStudentsView() {
    notificationsEl.style.display = 'none';
    studentListEl.style.display = 'block';
  }
  function showNotificationsView() {
    studentListEl.style.display = 'none';
    notificationsEl.style.display = 'block';
    loadNotifications();
  }

  // Привязываем кнопки в шапке
  document.getElementById('showStudents')
    .addEventListener('click', e => { e.preventDefault(); showStudentsView(); });
  document.getElementById('showNotifications')
    .addEventListener('click', e => { e.preventDefault(); showNotificationsView(); });

  // Показываем студенты по-умолчанию
  showStudentsView();

  // Загрузка информации о группе
  const group = localStorage.getItem('curatorGroup');
  if (group && groupElement) groupElement.textContent = `Ваша группа: ${group}`;

  // Открытие/закрытие модального окна смены пароля
  document.getElementById('changePasswordBtn').addEventListener('click', () => {
    document.getElementById('passwordModal').style.display = 'flex';
  });
  document.getElementById('closePasswordModal').addEventListener('click', () => {
    document.getElementById('passwordModal').style.display = 'none';
  });

  // Обработка смены пароля
  document.getElementById('submitPasswordChange').addEventListener('click', () => {
    const oldPassword = document.getElementById('oldPassword').value.trim();
    const newPassword = document.getElementById('newPassword').value.trim();
    const role = localStorage.getItem('role');
    const id   = localStorage.getItem(`${role}Id`);
    const errorBlock = document.getElementById('passwordError');

    if (!oldPassword || !newPassword) {
      errorBlock.textContent = 'Заполните все поля';
      return;
    }

    fetch('https://medapp-to7o.onrender.com/api/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ role, id, oldPassword, newPassword })
    })
      .then(res => res.json())
      .then(data => {
        if (data.message.includes('Пароль должен')) {
          errorBlock.textContent = data.message;
        } else {
          alert(data.message);
          document.getElementById('passwordModal').style.display = 'none';
        }
      })
      .catch(() => {
        errorBlock.textContent = 'Ошибка при смене пароля';
      });
  });
});
</script>


  <script src="curator-dashboard.js"></script>
  
  <div id="passwordModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" id="closePasswordModal">&times;</span>
      <h3>Смена пароля</h3>
      <input type="password" id="oldPassword" placeholder="Старый пароль" />
      <input type="password" id="newPassword" placeholder="Новый пароль" />
      <div id="passwordError" style="color:red; margin: 0.5rem 0;"></div>
      <button id="submitPasswordChange">Изменить пароль</button>
    </div>
  </div>
  
  <style>
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    .close {
      float: right;
      font-size: 24px;
      cursor: pointer;
    }
    /* Стили для уведомлений */
  .notifications-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }
  .notifications-list li {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #ddd;
  }
  .notifications-list li:last-child {
    border-bottom: none;
  }
  .notifications-list li.unread {
    background-color: #f9f9f9;
    font-weight: bold;
  }

  </style>
  
</body>
</html>
