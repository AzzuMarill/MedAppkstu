<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞–±–∏–Ω–µ—Ç –≤—Ä–∞—á–∞</title>
  <link rel="stylesheet" href="univer-style.css" />
  <style>
    .main-content {
      display: flex;
      flex-direction: row-reverse;
      margin: 0;
    }
    .right-sidebar {
      width: 220px;
      background-color: var(--aside-bg);
      border: 1px solid var(--border-color);
      padding: 1rem;
      margin-left: 1rem;
    }
    .left-panel {
      flex: 1;
      background-color: var(--content-bg);
      border: 1px solid var(--border-color);
      padding: 1rem;
    }
    #searchInput {
      width: 300px;
      margin-bottom: 0.5rem;
    }
    .modal {
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: #fff;
      padding: 2rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      width: 400px;
      max-width: 90%;
      position: relative;
    }
    .close {
      position: absolute;
      top: 0.5rem;
      right: 1rem;
      cursor: pointer;
      font-size: 1.4rem;
    }
  </style>
</head>
<body>
<div class="page-wrapper">
  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–µ –º–µ–Ω—é -->
  <header class="header">
    <div class="header-top">
      <img src="img/logo.png" alt="Logo" class="header-logo" />
      <div class="header-title">Students medical app</div>
    </div>
    <nav class="header-menu">
      <ul class="menu">
        <li><a href="home.html">–ì–ª–∞–≤–Ω–æ–µ</a></li>
        <li><a href="#" id="profileLink">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a></li>
        <li><a href="https://www.kstu.kz/" target="_blank">–û—Ñ.—Å–∞–π—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞</a></li>
        <li><a href="https://egov.kz/cms/kk" target="_blank">egov</a></li>
      </ul>
      <ul class="menu exit">
        <li><a href="login.html">–í—ã—Ö–æ–¥</a></li>
      </ul>
    </nav>
  </header>


  <div class="main-content">
    <aside class="right-sidebar">
      <h3>–ú–µ–Ω—é</h3>
      <ul style="list-style: none; padding-left: 0;">
        <li><a href="#" onclick="showStudentForms(event)">–ê–Ω–∫–µ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</a></li>
        <li><a href="#" onclick="showVisits(event)">–ó–∞–ø–∏—Å–∞—Ç—å –≤–∏–∑–∏—Ç</a></li>
        <li><a href="#" onclick="showDoctorVisits(event)">–ú–æ–∏ –≤–∏–∑–∏—Ç—ã</a></li>
        <li><a href="#" id="changePasswordBtn">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</a></li>
      </ul>
    </aside>

    <section class="left-panel">
      <h2>–û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h2>
      <div id="content">
        <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
        <p>–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∞–Ω–∫–µ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤–∏–∑–∏—Ç—ã –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–∞—Ä–æ–ª–µ–º.</p>
        <div style="display: flex; justify-content: space-around; margin-top: 2rem;">
          <div><strong>üë• –°—Ç—É–¥–µ–Ω—Ç–æ–≤:</strong><br><span id="countStudents">‚Äì</span></div>
          <div><strong>üìã –ê–Ω–∫–µ—Ç:</strong><br><span id="countForms">‚Äì</span></div>
          <div><strong>üìÜ –í–∏–∑–∏—Ç–æ–≤:</strong><br><span id="countVisits">‚Äì</span></div>
        </div>
      </div>      
    </section>
  </div>

  <footer class="footer">
    ¬© 2025 Students medical app
  </footer>
</div>

<div id="modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∞–Ω–∫–µ—Ç–∞</h3>
    <div id="modal-body"></div>
  </div>
</div>

<script>
let allStudents = [];

function showStudentForms(e) {
  e.preventDefault();
  const contentHtml = `
    <h3>–ê–Ω–∫–µ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h3>
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û –∏–ª–∏ –≥—Ä—É–ø–ø–µ..." onkeyup="filterStudents()" />
    <table id="studentsTable">
      <thead>
        <tr><th>–§–ò–û</th><th>–ì—Ä—É–ø–ø–∞</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  `;
  document.getElementById('content').innerHTML = contentHtml;

  if (allStudents.length === 0) {
    fetch('http://localhost:3000/api/students-list')
      .then(res => res.json())
      .then(data => {
        allStudents = data;
        renderStudentsTable(allStudents);
      });
  } else {
    renderStudentsTable(allStudents);
  }
}

function renderStudentsTable(students) {
  const tbody = document.querySelector('#studentsTable tbody');
  tbody.innerHTML = '';
  students.forEach(stud => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><a href="#" onclick="openStudentModal(${stud.id})">${stud.fio}</a></td>
      <td>${stud.group_name || ''}</td>
    `;
    tbody.appendChild(tr);
  });
}

function filterStudents() {
  const searchValue = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allStudents.filter(stud => {
    return stud.fio.toLowerCase().includes(searchValue) || (stud.group_name || '').toLowerCase().includes(searchValue);
  });
  renderStudentsTable(filtered);
}

function openStudentModal(studentId) {
  fetch(`http://localhost:3000/api/medical-data/${studentId}`)
    .then(res => res.json())
    .then(data => {
      if (data.message) {
        document.getElementById('modal-body').innerHTML = `<p>${data.message}</p>`;
      } else {
        document.getElementById('modal-body').innerHTML = `
          <p><strong>–ü–æ–ª–Ω–æ–µ –∏–º—è:</strong> ${data.full_name || ''}</p>
          <p><strong>Email:</strong> ${data.email || ''}</p>
          <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${data.phone || ''}</p>
          <p><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> ${data.dob || ''}</p>
          <p><strong>–ü–æ–ª:</strong> ${data.gender || ''}</p>
          <p><strong>–ì—Ä—É–ø–ø–∞:</strong> ${data.occupation || ''}</p>
          <p><strong>–ê–¥—Ä–µ—Å:</strong> ${data.address || ''}</p>
          <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç –≤ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–º —Å–ª—É—á–∞–µ:</strong> ${data.emergency_contact || ''} (${data.emergency_number || ''})</p>
          <p><strong>–õ–µ—á–∞—â–∏–π –≤—Ä–∞—á:</strong> ${data.primary_physician || ''}</p>
          <p><strong>–ê–ª–ª–µ—Ä–≥–∏–∏:</strong> ${data.allergies || ''}</p>
          <p><strong>–¢–µ–∫—É—â–∏–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞:</strong> ${data.current_medication || ''}</p>
          <p><strong>–°–µ–º–µ–π–Ω—ã–π –∞–Ω–∞–º–Ω–µ–∑:</strong> ${data.family_history || ''}</p>
          <p><strong>–ü—Ä–æ—à–ª—ã–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è:</strong> ${data.past_history || ''}</p>
        `;
      }
      document.getElementById('modal').style.display = 'flex';
    });
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

function showVisits(e) {
  e.preventDefault();
  document.getElementById('content').innerHTML = `
    <h3>–ó–∞–ø–∏—Å—å –≤–∏–∑–∏—Ç–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞</h3>
    <form id="visitForm" enctype="multipart/form-data">
      <div class="form-group">
        <label for="studentSearch">–ü–æ–∏—Å–∫ —Å—Ç—É–¥–µ–Ω—Ç–∞</label>
        <input type="text" id="studentSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û..." autocomplete="off" />
        <ul id="studentSuggestions" style="list-style: none; padding-left: 0; margin-top: 0.3rem;"></ul>
        <input type="hidden" id="studentId" />
      </div>
      <div class="form-group">
        <label for="visitDate">–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞</label>
        <input type="datetime-local" id="visitDate" required />
      </div>
      <div class="form-group">
        <label for="complaints">–ü—Ä–∏—á–∏–Ω–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è</label>
        <input type="text" id="complaints" required />
      </div>
      <div class="form-group">
        <label><input type="checkbox" id="isExempted" /> –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ—Ç –∑–∞–Ω—è—Ç–∏–π</label>
      </div>
      <div class="form-group" id="fileField" style="display: none;">
        <label for="exemptionFile">–§–∞–π–ª –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è</label>
        <input type="file" id="exemptionFile" accept=".pdf,.jpg,.png" />
      </div>
      <button type="submit" class="btn-submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–∑–∏—Ç</button>
    </form>
  `;

  let students = [];
  fetch('http://localhost:3000/api/students-list')
    .then(res => res.json())
    .then(data => {
      students = data;
    });

  document.getElementById('visitDate').value = new Date().toISOString().slice(0,16);

  document.getElementById('studentSearch').addEventListener('input', function () {
    const query = this.value.trim().toLowerCase();
    const ul = document.getElementById('studentSuggestions');
    ul.innerHTML = '';
    document.getElementById('studentId').value = '';

    const matched = students.find(s => s.fio.toLowerCase() === query);
    if (matched) {
      document.getElementById('studentId').value = matched.id;
    }

    const filtered = students.filter(s => s.fio.toLowerCase().includes(query)).slice(0, 10);
    filtered.forEach(st => {
      const li = document.createElement('li');
      li.textContent = `${st.fio} (${st.group_name || ''})`;
      li.style.cursor = 'pointer';
      li.onclick = () => {
        document.getElementById('studentSearch').value = st.fio;
        document.getElementById('studentId').value = st.id;
        ul.innerHTML = '';
      };
      ul.appendChild(li);
    });
  });

  document.getElementById('isExempted').onchange = function () {
    document.getElementById('fileField').style.display = this.checked ? 'block' : 'none';
  };

  document.getElementById('visitForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const doctorId = localStorage.getItem('doctorId');
    const studentId = document.getElementById('studentId').value.trim();
    const visitDate = document.getElementById('visitDate').value;
    const complaints = document.getElementById('complaints').value.trim();
    const isExempted = document.getElementById('isExempted').checked;
    const exemptionFile = document.getElementById('exemptionFile').files[0];

    console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–∑–∏—Ç–∞:", { doctorId, studentId, visitDate, complaints });

    if (!doctorId || !studentId || !visitDate || !complaints) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞.');
      return;
    }

    const formData = new FormData();
    formData.append('doctorId', doctorId);
    formData.append('studentId', studentId);
    formData.append('visitDate', visitDate);
    formData.append('complaints', complaints);
    formData.append('isExempted', isExempted ? '1' : '0');
    if (isExempted) {
      if (!exemptionFile) {
        alert('–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª.');
        return;
      }
      formData.append('exemptionFile', exemptionFile);
    }

    try {
      const res = await fetch('http://localhost:3000/api/doctor-visits', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      alert(data.message || '–í–∏–∑–∏—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
      this.reset();
      document.getElementById('fileField').style.display = 'none';
      document.getElementById('studentSuggestions').innerHTML = '';
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:', err);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö');
    }
  });
}

function showDoctorVisits(e) {
  e.preventDefault();
  const doctorId = localStorage.getItem('doctorId');
  if (!doctorId) return alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—Ä–∞—á–∞");

  fetch(`http://localhost:3000/api/doctor-visits/doctor/${doctorId}`)
    .then(res => res.json())
    .then(data => {
      const content = document.getElementById('content');
      if (!Array.isArray(data) || data.length === 0) {
        content.innerHTML = '<p>–í–∏–∑–∏—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
        return;
      }

      content.innerHTML = `
        <h3>–ú–æ–∏ –≤–∏–∑–∏—Ç—ã</h3>
        <table>
          <thead>
            <tr>
              <th>–°—Ç—É–¥–µ–Ω—Ç</th>
              <th>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞</th>
              <th>–ñ–∞–ª–æ–±—ã</th>
              <th>–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(visit => `
              <tr>
                <td>${visit.student_name}</td>
                <td>${visit.visit_date}</td>
                <td>${visit.complaints}</td>
                <td>
                  ${visit.exemption_file 
                    ? `<a href="http://localhost:3000${visit.exemption_file}" download>üìÑ –°–∫–∞—á–∞—Ç—å</a>` 
                    : '‚Äî'}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    })
    .catch(err => {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–∑–∏—Ç–æ–≤ –≤—Ä–∞—á–∞:', err);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–∑–∏—Ç–æ–≤');
    });
}

document.getElementById('changePasswordBtn').addEventListener('click', () => {
  const content = document.getElementById('content');
  content.innerHTML = `
    <h3>–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
    <input type="password" id="oldPassword" placeholder="–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å" />
    <input type="password" id="newPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" />
    <div id="passwordError" style="color:red; margin-bottom:0.5rem;"></div>
    <button id="submitPasswordChange">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
  `;

  document.getElementById('submitPasswordChange').addEventListener('click', () => {
    const oldPassword = document.getElementById('oldPassword').value.trim();
    const newPassword = document.getElementById('newPassword').value.trim();
    const role = localStorage.getItem('role');
    const id = localStorage.getItem(`${role}Id`);
    const errorBlock = document.getElementById('passwordError');

    if (!oldPassword || !newPassword) {
      errorBlock.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
      return;
    }

    fetch('http://localhost:3000/api/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ role, id, oldPassword, newPassword })
    })
      .then(res => res.json())
      .then(data => {
        if (data.message.includes("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω")) {
          errorBlock.textContent = data.message;
        } else {
          errorBlock.textContent = '';
          alert(data.message);
          document.getElementById('oldPassword').value = '';
          document.getElementById('newPassword').value = '';
        }
      })
      .catch(err => {
        console.error('–û—à–∏–±–∫–∞:', err);
        errorBlock.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è';
      });
  });
});
// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
const doctorId = localStorage.getItem('doctorId');
if (doctorId) {
  fetch(`http://localhost:3000/api/doctor-dashboard-stats/${doctorId}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('countStudents').textContent = data.students || 0;
      document.getElementById('countForms').textContent = data.forms || 0;
      document.getElementById('countVisits').textContent = data.visits || 0;
    })
    .catch(err => {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
    });
}

</script>
</body>
</html>
