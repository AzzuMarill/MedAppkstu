<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü—Ä–æ—Ñ–∏–ª—å —Å—Ç—É–¥–µ–Ω—Ç–∞</title>
  <div id="accessDeniedMessage" style="display:none; padding: 10px; background: #ffcccc; color: #a00; font-weight: bold; text-align: center;">
    –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞...
  </div>
  
  <script>
    const role = localStorage.getItem('role');
    const id = localStorage.getItem('userId');
    const allowedRole = 'student';
    const messageBlock = document.getElementById('accessDeniedMessage');
  
    if (!id || role !== allowedRole) {
      messageBlock.style.display = 'block';
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 3000);
    }
  </script>  
  <link rel="stylesheet" href="univer-style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>
<body>
  <div class="page-wrapper">
    <header class="header">
      <div class="header-top">
        <img src="img/logo.png" alt="Logo" class="header-logo" />
        <div class="header-title">Students medical app</div>
      </div>
      <nav class="header-menu">
        <ul class="menu">
          <li><a href="home.html">–ì–ª–∞–≤–Ω–æ–µ</a></li>
          <li><a href="#" id="showFormBtn">–ú–æ—è –∞–Ω–∫–µ—Ç–∞</a></li>
          <li><a href="https://www.kstu.kz/" target="_blank">–û—Ñ.—Å–∞–π—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞</a></li>
          <li><a href="https://egov.kz/cms/kk" target="_blank">egov</a></li>
        </ul>
        <ul class="menu exit">
          <li><a href="login.html" onclick="localStorage.clear()">–í—ã—Ö–æ–¥</a></li>
        </ul>
      </nav>
    </header>

    <div class="main-content">
      <aside class="left-sidebar">
        <h3>–ú–µ–Ω—é</h3>
        <ul>
          <li><a href="student-dashboard.html">–ü—Ä–æ—Ñ–∏–ª—å</a></li>
          <li><a href="#" id="showFormBtnSidebar">–ú–æ—è –∞–Ω–∫–µ—Ç–∞</a></li>
          <li><a href="#" id="showVisitsBtn">–í–∏–∑–∏—Ç—ã –∫ –≤—Ä–∞—á—É</a></li>
          <li><a href="#" id="showXrayBtn">–°–Ω–∏–º–æ–∫ —Ñ–ª—é–æ—Ä–æ–≥—Ä–∞—Ñ–∏–∏</a></li>
          <li><a href="#" id="changePasswordBtn">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</a></li>
        </ul>
      </aside>

      <section class="center-content">
        <div id="welcomeBlock">
          <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
          <div id="studentInfo" class="student-info" style="margin-bottom: 1.5rem;"></div>
        </div>        
        <div id="dynamicContent"></div>            
      </section>
    </div>

    <footer class="footer">
      ¬© 2025 Students medical app
    </footer>
  </div>

  <script>
    const studentId = localStorage.getItem('studentId');
    const fio = localStorage.getItem('studentFio');
    const email = localStorage.getItem('studentEmail');
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–∞
    fetch(`http://localhost:3000/api/student-profile/${studentId}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('studentInfo').innerHTML = `
        <p><strong>–§–ò–û:</strong> <span id="studentName">${fio}</span></p>
        <p><strong>Email:</strong> <span id="studentEmail">${email}</span></p>`;
      });

    // === –ê–ù–ö–ï–¢–ê ===
    function showMedicalForm(e) {
      e.preventDefault();
      document.getElementById('welcomeBlock').style.display = 'none';
      const content = document.getElementById('dynamicContent');
      fetch('long-form.html')
        .then(res => res.text())
        .then(html => {
          const temp = document.createElement('div');
          temp.innerHTML = html;
          const form = temp.querySelector('form');
          if (form) {
            content.innerHTML = '<h2>–ê–Ω–∫–µ—Ç–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞</h2>';
            content.appendChild(form);
            loadFormData();
            setupMedicalFormSubmit();
          }
        });
    }

    document.getElementById('showFormBtn').addEventListener('click', showMedicalForm);
    document.getElementById('showFormBtnSidebar').addEventListener('click', showMedicalForm);

    function loadFormData() {
      const studentId = localStorage.getItem('studentId') || localStorage.getItem('userId');
      fetch(`http://localhost:3000/api/medical-data/${studentId}`)
        .then(res => res.json())
        .then(data => {
          if (!data || data.message) return;
          document.getElementById('fullName').value = data.full_name || '';
          document.getElementById('email').value = data.email || '';
          document.getElementById('phone').value = data.phone || '';
          document.getElementById('dob').value = data.dob || '';
          document.querySelector(`input[name="gender"][value="${data.gender}"]`)?.click();
          document.getElementById('occupation').value = data.occupation || '';
          document.getElementById('address').value = data.address || '';
          document.getElementById('emergencyContact').value = data.emergency_contact || '';
          document.getElementById('emergencyNumber').value = data.emergency_number || '';
          document.getElementById('primaryPhysician').value = data.primary_physician || '';
          document.getElementById('treatingDoctor').value = data.treatingDoctor || '';
          document.getElementById('allergies').value = data.allergies || '';
          document.getElementById('currentMedication').value = data.current_medication || '';
          document.getElementById('familyHistory').value = data.family_history || '';
          document.getElementById('pastHistory').value = data.past_history || '';
        });
    }

    // === –í–ò–ó–ò–¢–´ ===
    document.getElementById('showVisitsBtn').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('welcomeBlock').style.display = 'none';
      const content = document.getElementById('dynamicContent');
      fetch(`http://localhost:3000/api/doctor-visits/student/${studentId}`)
        .then(res => res.json())
        .then(visits => {
          if (!Array.isArray(visits)) {
            content.innerHTML = '<p>–ù–µ—Ç –≤–∏–∑–∏—Ç–æ–≤.</p>';
            return;
          }
          content.innerHTML = `
          <h3>–ú–æ–∏ –≤–∏–∑–∏—Ç—ã</h3>
          <table>
            <thead>
              <tr>
                <th>–î–∞—Ç–∞</th>
                <th>–ñ–∞–ª–æ–±—ã</th>
                <th>–í—Ä–∞—á</th>
                <th>–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ</th>
              </tr>
            </thead>
            <tbody>
              ${visits.map(v => `
                <tr>
                  <td>${v.visit_date}</td>
                  <td>${v.complaints}</td>
                  <td>${v.doctor_name}</td>
                  <td>
                    ${v.exemption_file
                      ? `<a href="http://localhost:3000${v.exemption_file}" download>üìÑ –°–∫–∞—á–∞—Ç—å</a>`
                      : '‚Äî'}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        });
    });

    // === –§–õ–Æ–û–†–û–ì–†–ê–§–ò–Ø ===
    document.getElementById('showXrayBtn').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('welcomeBlock').style.display = 'none';
      const content = document.getElementById('dynamicContent');
      content.innerHTML = `
        <h3>–°–Ω–∏–º–æ–∫ —Ñ–ª—é–æ—Ä–æ–≥—Ä–∞—Ñ–∏–∏</h3>
        <div style="margin-bottom: 1rem;">
          <input type="file" id="xrayUpload" accept="image/*" />
          <button id="uploadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
        <div id="xrayPreview">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      `;
      loadXray();

      document.getElementById('uploadBtn').addEventListener('click', () => {
        const file = document.getElementById('xrayUpload').files[0];
        if (!file) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏");

        const studentId = localStorage.getItem('studentId') || localStorage.getItem('userId');
        const formData = new FormData();
        formData.append('image', file);
        formData.append('studentId', studentId);

        fetch('http://localhost:3000/api/xray-upload', {
          method: 'POST',
          body: formData
        })
          .then(res => res.json())
          .then(data => {
            alert(data.message || '–ó–∞–≥—Ä—É–∂–µ–Ω–æ');
            loadXray();
          })
          .catch(err => {
            console.error(err);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–Ω–∏–º–∫–∞');
          });
      });
    });

    function loadXray() {
      const studentId = localStorage.getItem('studentId') || localStorage.getItem('userId');
      fetch(`http://localhost:3000/api/xray/${studentId}`)
        .then(res => res.json())
        .then(data => {
          const preview = document.getElementById('xrayPreview');
          if (!data || !data.imageUrl) {
            preview.innerHTML = "<p>–°–Ω–∏–º–æ–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.</p>";
            return;
          }
          preview.innerHTML = `
            <p>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Å–Ω–∏–º–æ–∫:</p>
            <img src="http://localhost:3000${data.imageUrl}" style="max-width: 300px;" />
            <br><br>
            <a href="http://localhost:3000${data.imageUrl}" download>–°–∫–∞—á–∞—Ç—å</a> |
            <button onclick="deleteXray()">–£–¥–∞–ª–∏—Ç—å</button>
          `;
        })
        .catch(() => {
          document.getElementById('xrayPreview').innerHTML = "<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–Ω–∏–º–∫–∞.</p>";
        });
    }

    function deleteXray() {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–Ω–∏–º–æ–∫?")) return;
      const studentId = localStorage.getItem('studentId') || localStorage.getItem('userId');
      fetch(`http://localhost:3000/api/xray/${studentId}`, {
        method: 'DELETE'
      })
        .then(res => res.json())
        .then(data => {
          alert(data.message || '–£–¥–∞–ª–µ–Ω–æ');
          document.getElementById('xrayPreview').innerHTML = "<p>–°–Ω–∏–º–æ–∫ —É–¥–∞–ª—ë–Ω.</p>";
        })
        .catch(err => {
          console.error(err);
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
        });
    }
  
function setupMedicalFormSubmit() {
  const form = document.querySelector('.big-form');
  if (!form) return;

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    document.getElementById('welcomeBlock').style.display = 'none';

    const formData = {
      student_id: localStorage.getItem('studentId'),
      full_name: document.getElementById('fullName').value,
      email: document.getElementById('email').value,
      phone: document.getElementById('phone').value,
      dob: document.getElementById('dob').value,
      gender: document.querySelector('input[name="gender"]:checked')?.value,
      occupation: document.getElementById('occupation').value,
      address: document.getElementById('address').value,
      emergency_contact: document.getElementById('emergencyContact').value,
      emergency_number: document.getElementById('emergencyNumber').value,
      primary_physician: document.getElementById('primaryPhysician').value,
      treatingDoctor: document.getElementById('treatingDoctor').value,
      allergies: document.getElementById('allergies').value,
      current_medication: document.getElementById('currentMedication').value,
      family_history: document.getElementById('familyHistory').value,
      past_history: document.getElementById('pastHistory').value,
    };

    fetch("http://localhost:3000/api/medical-data", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message || '–ê–Ω–∫–µ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
    })
    .catch(err => {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∞–Ω–∫–µ—Ç—ã:', err);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∞–Ω–∫–µ—Ç—ã');
    });
  });
}

function changePassword() {
  const oldPassword = document.getElementById('oldPassword').value.trim();
  const newPassword = document.getElementById('newPassword').value.trim();
  const studentId = localStorage.getItem('studentId') || localStorage.getItem('userId');

  if (!oldPassword || !newPassword) {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è.');
    return;
  }

  fetch("http://localhost:3000/api/change-password/student", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id: studentId, oldPassword, newPassword })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    document.getElementById('oldPassword').value = '';
    document.getElementById('newPassword').value = '';
  })
  .catch(err => {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è:', err);
    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
  });
}
document.getElementById('changePasswordBtn').addEventListener('click', (e) => {
  e.preventDefault();
  document.getElementById('welcomeBlock').style.display = 'none';
  const content = document.getElementById('dynamicContent');
  content.innerHTML = `
    <h3>–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
    <input type="password" id="oldPassword" placeholder="–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å" />
    <input type="password" id="newPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" />
    <div id="passwordError" class="error-message" style="color: red; margin-top: 0.5rem;"></div>
    <button id="submitPasswordChange">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
  `;

  document.getElementById('submitPasswordChange').addEventListener('click', () => {
    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const errorBlock = document.getElementById('passwordError');
    const studentId = localStorage.getItem('studentId') || localStorage.getItem('userId');

    fetch('http://localhost:3000/api/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        role: 'student',
        id: localStorage.getItem('studentId'),
        oldPassword,
        newPassword
      })
    })
      .then(res => res.json())
      .then(data => {
        if (data.message.includes("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω")) {
          errorBlock.textContent = data.message;
        } else {
          errorBlock.textContent = '';
          alert(data.message);
          document.getElementById('oldPassword').value = '';
          document.getElementById('newPassword').value = '';
        }
      })
      .catch(err => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è:', err);
        errorBlock.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è';
      });
  });
});
  document.addEventListener("DOMContentLoaded", () => {
    const fio = localStorage.getItem('studentFio');
    const email = localStorage.getItem('studentEmail');

    if (!fio || !email) {
      window.location.href = "login.html";
      return;
    }

    const nameEl = document.getElementById('studentName');
    const emailEl = document.getElementById('studentEmail');

    if (nameEl) nameEl.textContent = fio;
    if (emailEl) emailEl.textContent = email;
  });
</script>

</body>
</html>
